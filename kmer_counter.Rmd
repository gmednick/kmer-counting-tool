---
title: "Kmer analysis"
author: "Gabe Mednick"
date: "7/30/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE)
```


```{r}
library("Biostrings")
library(tidyverse)
library(gt)
library(patchwork)
theme_set(theme_light())
```

Dear collegue, \
Thanks for sharing your concern about the kmer frequencies in your experiments. I had a chance to look at the fasta files that you sent me and, as you suspected, the kmer counts are not evenly distributed.  

## Table of Kmer counts by Experiment
```{r}
ex1 = readDNAStringSet('takehome/challenge1/experiment1.fasta')
ex2 = readDNAStringSet('takehome/challenge1/experiment2.fasta')
ex3 = readDNAStringSet('takehome/challenge1/experiment3.fasta')
ex4 = readDNAStringSet('takehome/challenge1/experiment4.fasta')
ex5 = readDNAStringSet("nonstandard_nucs.fasta")

fasta_files = list(ex1, ex2, ex3, ex4)

convert_to_df <- function(s) {
seq_name = names(s)
sequence = paste(s)
df <- tibble(seq_name, sequence)
}

fasta_df <- map_df(fasta_files, convert_to_df) 
fasta_df$seq_name = c('ex1', 'ex2', 'ex3', 'ex4')

# https://github.com/tidyverse/stringr/issues/292
str_dice <- function(s, length) { # does not return list
   L <- str_length(s)
   str_sub(s, start=seq(1L,L-length+1,length), end=seq(length,L,length))
}

count_kmers <- function(tbl) {
  tbl %>% 
    str_dice(length = 4) %>% 
    tibble() %>% 
    rename(kmer = ".") %>%
    count(kmer, sort = T, name = 'kmer_count') %>% 
    mutate(kmer = fct_reorder(kmer, kmer_count)) %>%
    mutate(standard_nucs = str_detect(kmer, "[non_stand_nucs]", negate = T))
}

ex5 <- convert_to_df(ex5)

ex_ns <- ex5$sequence %>% 
  str_dice(4) %>% tibble() %>% 
  rename(kmer = ".") 
 
```


```{r}
seq1 <- fasta_df$sequence[1] %>%
   count_kmers() %>% 
   mutate(example = 'Ex1_counts')
 
 seq2 <- fasta_df$sequence[2] %>%
  count_kmers() %>% 
   mutate(example = 'Ex2_counts')
 
 seq3 <- fasta_df$sequence[3] %>%
  count_kmers() %>% 
   mutate(example = 'Ex3_counts')
 
 seq4 <- fasta_df$sequence[4] %>%
  count_kmers() %>% 
   mutate(example = 'Ex4_counts')

sequences <- bind_rows(seq1, seq2, seq3, seq4) 

sequences %>% 
  pivot_wider(names_from = example, values_from = kmer_count) %>% 
  gt() %>% 
  tab_header(title = md("**Kmer counts by experiment**"),)  %>% 
  tab_options(container.height = 400,
              container.overflow.y = TRUE,
              heading.background.color = "#EFFBFC", 
              table.width = "75%", 
              column_labels.background.color = "black",
              table.font.color = "black") %>% 
  tab_style(style = list(cell_fill(color = "Grey")),
            locations = cells_body())
```
<br>

The imbalance in kmer counts is easier to observe as a bar plot. Notably, experiments 1 and 2 have the most skewed distributions of kmer counts.  

```{r}
p1 <- fasta_df$sequence[1] %>% 
  count_kmers() %>% 
  # mutate(kmer = fct_lump(kmer, n = 25, w = kmer_count)) %>% 
  # filter(kmer != "Other") %>% 
  ggplot(aes(kmer_count, kmer, fill = kmer_count)) +
  geom_col() +
  scale_fill_viridis_c() +
  theme(legend.position = 'none') +
  labs(title = 'Ex1 kmer counts') +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
  
p2 <- fasta_df$sequence[2] %>% 
  count_kmers() %>% 
  # mutate(kmer = fct_lump(kmer, n = 25, w = kmer_count)) %>% 
  # filter(kmer != "Other") %>% 
  ggplot(aes(kmer_count, kmer, fill = kmer_count)) +
  geom_col() +
  scale_fill_viridis_c() +
  theme(legend.position = 'none') +
  labs(title = 'Ex2 kmer counts') +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())

p3 <- fasta_df$sequence[3] %>% 
  count_kmers() %>% 
  # mutate(kmer = fct_lump(kmer, n = 25, w = kmer_count)) %>% 
  # filter(kmer != "Other") %>% 
  ggplot(aes(kmer_count, kmer, fill = kmer_count)) +
  geom_col() +
  scale_fill_viridis_c() +
  theme(legend.position = 'none') +
  labs(title = 'Ex3 kmer counts') +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())

p4 <- fasta_df$sequence[4] %>% 
  count_kmers() %>% 
  # mutate(kmer = fct_lump(kmer, n = 25, w = kmer_count)) %>% 
  # filter(kmer != "Other") %>% 
  ggplot(aes(kmer_count, kmer, fill = kmer_count)) +
  geom_col() +
  scale_fill_viridis_c() +
  theme(legend.position = 'none') +
  labs(title = 'Ex4 kmer counts') +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())

(p1 + p2) / (p3 + p4)
```

The distributions patterns are more evident when viewed as a density plot. Experiment 4 is your golden ticket. If anything was different with this experiment, you might be able to identify your problem. 

```{r}
sequences %>% 
  group_by(example) %>% 
  ggplot(aes(kmer_count, fill = example)) +
  geom_density() +
  facet_wrap(~example) +
  scale_fill_viridis_d() +
  theme(legend.position = 'none') +
  labs(title = "Density distributions of kmers(4mer) by length",
       x = "Kmer length",
       y = "Density")
```

To help you check for imbalanced kmer distributions in future experiments, I designed a kmer counting analysis tool that works from the command line. The kmer counter let's you input a fasta file and kmer length, and returns a tab separated file of kmer counts ordered by frequency. The program also returns messages about the analysis in the command line. 

To use the tool: \
1. Clone the project from my GitHub repo (https://github.com/gmednick/kmer_analysis_tool) \
2. From the command line, go to the directory and change the permissions such that the kmer_counter_tool.R script is executable (chmod +x kmer_counter_tool.R) \
3. Using the following incantation to run the script: \
Rscript kmer_counter_tool.R 'input_file' kmer-length 'output_file' \
4. See the example image for expected inputs and outputs (Note: I am working on a mac)

![](kmer-tool-bash-img.png)

